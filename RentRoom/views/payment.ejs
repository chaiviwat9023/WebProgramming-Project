<%- include("partials/head") %>
<body>
    <!-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Navbar -->
    <%- include("partials/nav") %>

    <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ -->
    <div class="content container-fluid">
        <h2 class="text-center mb-4">üí≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h2>
        <!-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ data ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà -->
        <% if (data && data.length > 0) { %>
            <p class="text-center">‡∏´‡πâ‡∏≠‡∏á <%= data[0].room_id %></p>
        <% } else { %>
            <p class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á</p>
        <% } %>
        <div class="table-responsive bg-light p-3 rounded shadow w-75 mx-auto">
            <table class="table table-bordered table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th>
                        <th>‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•</th>
                        <th>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</th>
                        <th>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</th>
                        <th>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</th>
                        <th>‡∏£‡∏ß‡∏°</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (data && data.length > 0) { %>
                        <% data.forEach((item)=>{ %>
                            <tr>
                                <td><%= item.bill_id %></td>
                                <td><%= item.billing_cycle %></td>
                                <td><%= item.rent %></td>
                                <td><%= item.water %></td>
                                <td><%= item.electricity %></td>
                                <td><%= item.total_amount %></td>
                                <td class="
                                    <%= item.status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' ? 'text-success fw-bold' :
                                    item.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? 'text-warning fw-bold' :
                                    item.status === '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' ? 'text-danger fw-bold' :
                                    'text-secondary fw-bold' %>">
                                    <%= item.status %>
                                </td>
                                <td>
                                    <% if (item.status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') { %>
                                        <span class="text-secondary fw-bold">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                                    <% } else if (item.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') { %>
                                        <span class="text-secondary fw-bold">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏¥‡∏•</span>
                                    <% } else { %>
                                        <button class="btn btn-primary btn-sm payment-btn" data-bill-id="<%= item.bill_id %>" data-bs-toggle="modal" data-bs-target="#paymentModal">
                                            ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                        </button>
                                    <% } %>                            
                                </td>
                            </tr>
                        <% }); %> 
                    <% } else { %>
                        <tr>
                            <td colspan="8" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•:</strong> <span id="modalBillId"></span></p>
                    <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> 123-4-56789-0</p>
                    <p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</p>

                    <div class="mb-3">
                        <label for="transferDate" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô</label>
                        <input type="date" class="form-control" id="transferDate">
                    </div>

                    <div class="mb-3">
                        <label for="transferTime" class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô</label>
                        <input type="time" class="form-control" id="transferTime">
                    </div>

                    <div class="mb-3">
                        <label for="slipUpload" class="form-label">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô (JPEG, PNG, GIF)</label>
                        <input type="file" class="form-control" id="slipUpload">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    <button type="button" class="btn btn-success" id="confirmPaymentBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Modal -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const paymentButtons = document.querySelectorAll('.payment-btn');
            const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
            const modal = new bootstrap.Modal(document.getElementById('paymentModal')); // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® modal

            let currentBillId;

            paymentButtons.forEach(button => {
                button.addEventListener('click', function() {
                    currentBillId = this.getAttribute('data-bill-id');
                    document.getElementById("modalBillId").textContent = currentBillId;
                    document.getElementById("transferDate").value = "";
                    document.getElementById("transferTime").value = "";
                    document.getElementById("slipUpload").value = "";
                });
            });

            confirmPaymentBtn.addEventListener('click', function() {
                const billId = currentBillId;
                const transferDate = document.getElementById('transferDate').value;
                const transferTime = document.getElementById('transferTime').value;
                const slipUpload = document.getElementById('slipUpload').files[0];

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (!billId || !transferDate || !transferTime || !slipUpload) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                const maxSize = 5 * 1024 * 1024; // 5MB

                if (!allowedTypes.includes(slipUpload.type)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (JPEG, PNG, GIF)');
                    return;
                }

                if (slipUpload.size > maxSize) {
                    alert('‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)');
                    return;
                }

                // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
                const reader = new FileReader();
                reader.onload = function (e) {
                    const slipImageBase64 = e.target.result;

                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                    fetch('/payment/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            bill_id: billId,
                            transfer_date: transferDate,
                            transfer_time: transferTime,
                            slip_image: slipImageBase64
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Response Data:", data);
                        if (data.success) {
                            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            modal.hide(); // ‡∏ã‡πà‡∏≠‡∏ô Modal
                            window.location.reload(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                        } else {
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message);
                            modal.hide(); // ‡∏ã‡πà‡∏≠‡∏ô Modal
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        modal.hide(); // ‡∏ã‡πà‡∏≠‡∏ô Modal
                    });
                };
                reader.readAsDataURL(slipUpload);
            });
        });
    </script>
</body>
</html>